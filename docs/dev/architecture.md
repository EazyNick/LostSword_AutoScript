# 시스템 아키텍처

이 문서는 LostSword_AutoScript의 시스템 아키텍처와 서버/클라이언트 역할을 설명합니다.

## 전체 아키텍처

```
┌─────────────────────────────────────────────────────────┐
│                    웹 브라우저 (클라이언트)                │
│  ┌──────────────────────────────────────────────────┐  │
│  │  UI/src/ (JavaScript, HTML, CSS)                │  │
│  │  - 워크플로우 편집기                              │  │
│  │  - 노드 기반 시각적 스크립트 편집                  │  │
│  │  - 실시간 상태 모니터링                           │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP/REST API
                     │ (JSON)
┌────────────────────▼────────────────────────────────────┐
│              FastAPI 서버 (백엔드)                       │
│  ┌──────────────────────────────────────────────────┐  │
│  │  API Layer (api/)                               │  │
│  │  - action_router.py: 게임 액션 API               │  │
│  │  - script_router.py: 스크립트 관리 API          │  │
│  │  - node_router.py: 노드 관리 API                │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Service Layer (services/)                      │  │
│  │  - action_service.py: 액션 처리 로직             │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Game Automation (game_automation/)             │  │
│  │  - screen_capture.py: 화면 캡처 및 이미지 매칭    │  │
│  │  - input_handler.py: 마우스/키보드 입력          │  │
│  │  - workflow_engine.py: 워크플로우 실행 엔진     │  │
│  │  - game_state.py: 게임 상태 관리                 │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Data Layer (db/)                               │  │
│  │  - database.py: SQLite 데이터베이스 연결         │  │
│  │  - workflows.db: 워크플로우 저장                 │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                     │
                     │ Windows API 호출
                     ▼
            ┌─────────────────┐
            │  Windows OS     │
            │  - 화면 캡처     │
            │  - 마우스/키보드 │
            │  - 프로세스 관리  │
            └─────────────────┘
```

## 백엔드 (FastAPI 서버)

### 역할
- 게임 자동화 로직 실행
- 워크플로우 저장 및 관리
- 화면 캡처 및 이미지 매칭
- 마우스/키보드 입력 제어
- 게임 상태 추적 및 관리

### 주요 기능

#### 1. 게임 액션 API (`api/action_router.py`)
- **클릭 액션**: 특정 좌표 클릭
- **이미지 터치**: 화면에서 이미지를 찾아 클릭
- **대기**: 지정된 시간만큼 대기
- **프로세스 포커스**: 특정 프로세스 창을 포그라운드로 가져오기

#### 2. 워크플로우 엔진 (`game_automation/workflow_engine.py`)
- 노드 기반 워크플로우 실행
- 순차적/병렬 실행 모드 지원
- 조건부 분기 처리
- 루프 실행

#### 3. 화면 캡처 (`game_automation/screen_capture.py`)
- 전체 화면 또는 영역 캡처
- OpenCV를 사용한 이미지 템플릿 매칭
- 재시도 로직 (화면 로딩 대기)
- 한글 경로 지원

#### 4. 입력 처리 (`game_automation/input_handler.py`)
- 마우스 클릭, 이동, 드래그
- 키보드 입력
- Windows API를 통한 저수준 제어

#### 5. 게임 상태 관리 (`game_automation/game_state.py`)
- 플레이어 정보 추적
- 인벤토리 상태 관리
- 위치 정보 저장

#### 6. 데이터베이스 (`db/database.py`)
- SQLite를 사용한 워크플로우 저장
- 노드 및 연결 정보 관리
- 스크립트 메타데이터 저장

## 프론트엔드 (웹 기반 UI)

### 역할
- 시각적 워크플로우 편집기 제공
- 노드 기반 스크립트 생성 및 편집
- 실시간 워크플로우 실행 모니터링
- 사용자 인터페이스 제공

### 주요 기능

#### 1. 워크플로우 편집기 (`pages/workflow/`)
- **노드 생성 및 편집**: 드래그 앤 드롭으로 노드 배치
- **연결선 관리**: 노드 간 연결을 시각적으로 표현
- **실행 시각화**: 실행 중인 노드를 색상으로 표시
- **저장/로드**: 워크플로우를 서버에 저장하고 불러오기

#### 2. 노드 시스템 (`js/components/node/`)
- **노드 타입**: 액션, 조건, 루프, 대기 등 다양한 노드 타입
- **노드 렌더링**: 각 노드 타입별 커스텀 렌더링
- **노드 설정**: 노드별 설정 모달 제공

#### 3. API 클라이언트 (`js/api/`)
- **RESTful API 통신**: 서버와의 HTTP 통신
- **에러 처리**: 네트워크 오류 및 서버 오류 처리
- **응답 파싱**: JSON 응답 처리

#### 4. 상태 관리
- **워크플로우 상태**: 현재 편집 중인 워크플로우 상태
- **실행 상태**: 워크플로우 실행 중 상태 추적
- **UI 상태**: 모달, 사이드바 등 UI 상태 관리

## 데이터 흐름

### 워크플로우 저장
```
사용자 (Ctrl+S)
  ↓
workflow-save-service.js
  ↓
POST /api/scripts/save
  ↓
script_router.py
  ↓
SQLite 데이터베이스 저장
```

### 워크플로우 실행
```
사용자 (F5 또는 실행 버튼)
  ↓
workflow-execution-service.js
  ↓
각 노드별 POST /api/action/execute
  ↓
action_service.py
  ↓
game_automation 모듈 실행
  ↓
Windows API 호출
```

### 이미지 매칭
```
이미지 터치 노드 실행
  ↓
POST /api/action/execute (action_type: image_touch)
  ↓
screen_capture.find_template()
  ↓
화면 캡처 → OpenCV 템플릿 매칭
  ↓
매칭 좌표 반환 → 클릭 실행
```

## 기술 스택

### 백엔드
- **FastAPI**: 웹 프레임워크
- **Uvicorn**: ASGI 서버
- **SQLite**: 데이터베이스
- **OpenCV**: 이미지 처리
- **PyAutoGUI**: 마우스/키보드 제어
- **pywin32**: Windows API 접근
- **psutil**: 프로세스 관리

### 프론트엔드
- **순수 JavaScript (ES6+)**: 모듈화된 구조
- **HTML5**: 마크업
- **CSS3**: 스타일링
- **Fetch API**: HTTP 통신

## 보안 고려사항

1. **CORS 설정**: 개발 환경에서만 모든 오리진 허용
2. **입력 검증**: 서버 측에서 모든 입력 검증
3. **경로 검증**: 파일 경로 주입 공격 방지
4. **에러 처리**: 민감한 정보가 로그에 노출되지 않도록 처리

## 확장성

### 새로운 노드 타입 추가
1. `UI/src/pages/workflow/config/nodes.config.js`에 노드 정보 추가
2. `UI/src/js/components/node/`에 노드 렌더링 파일 생성
3. `server/services/action_service.py`에 실행 로직 추가

자세한 내용은 [노드 추가 가이드](node.md)를 참고하세요.

### 새로운 API 엔드포인트 추가
1. `server/api/`에 새로운 라우터 파일 생성 또는 기존 라우터에 추가
2. `server/main.py`에 라우터 등록
3. 필요시 `server/services/`에 비즈니스 로직 추가

## 관련 문서

- [프로젝트 구조](project-structure.md)
- [개발 환경 설정](development.md)
- [노드 추가 가이드](node.md)
- [워크플로우 구조](workflow-structure.md)

