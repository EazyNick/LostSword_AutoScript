# 로직 노드 (Logic Nodes)

로직 노드는 워크플로우의 실행 흐름을 제어하는 노드입니다.

## 구현된 노드

### repeat (반복 노드)

아래에 연결된 노드들을 지정한 횟수만큼 반복 실행하는 노드입니다.

**파일 위치**: `server/nodes/logicnodes/repeat.py`

**노드 타입**: `repeat`

**설명**: 반복 노드는 워크플로우 실행을 제어하는 특수 노드입니다. 서버에서는 반복 횟수만 검증하고 반환하며, 실제 반복 실행은 프론트엔드의 `WorkflowExecutionService`에서 처리됩니다. 반복 노드의 하위 연결점(bottom-output)에 연결된 노드 체인을 수집하여 지정된 횟수만큼 반복 실행합니다.

#### 파라미터

- `repeat_count` (number, 기본값: 1): 반복 횟수 (1 이상의 정수)

#### 출력 스키마

```json
{
  "action": "repeat",
  "status": "completed",
  "output": {
    "repeat_count": 3,
    "completed": true,
    "iterations": []
  }
}
```

**참고**: `iterations` 필드는 실제 반복 실행이 완료된 후 워크플로우 실행 엔진에서 채워집니다.

#### 동작 방식

반복 노드는 **서버**와 **프론트엔드**에서 협력하여 동작합니다:

**1. 서버 측 (repeat.py)**
- `repeat_count` 파라미터를 추출하고 검증합니다
- 숫자가 아니거나 1보다 작으면 기본값 1을 사용합니다
- 소수점이 있으면 정수로 변환합니다
- 반복 횟수만 포함한 결과를 반환합니다 (실제 반복 실행은 하지 않음)

**2. 프론트엔드 측 (workflow-execution-service.js)**
- 반복 노드 실행 결과를 받아 `repeat_count`를 확인합니다
- 반복 노드의 하위 연결점(bottom-output)에 연결된 노드를 찾습니다
- 연결을 따라가며 반복할 노드 체인을 수집합니다 (BFS 방식)
- 각 반복마다:
  - 반복 정보 메타데이터(`repeat_info`)를 각 노드에 추가합니다
  - 서버에 API 요청을 보내 노드 체인을 실행합니다
  - 실행 결과를 수집합니다
  - UI를 실시간으로 업데이트합니다

#### 상세 실행 흐름

```
1. 반복 노드 실행 요청
   ↓
2. 서버: repeat_count 검증 및 반환
   {
     "action": "repeat",
     "status": "completed",
     "output": {
       "repeat_count": 3,
       "completed": true,
       "iterations": []
     }
   }
   ↓
3. 프론트엔드: 반복 노드 감지
   - nodeData.type === 'repeat' 확인
   - nodeResult.output.repeat_count 추출
   ↓
4. 하위 노드 체인 수집
   - bottom-output 연결점에서 시작
   - 출력 연결을 따라가며 노드 체인 구성
   - 순환 방지 (visited Set 사용)
   - 반복 노드로 돌아가는 연결 제외
   ↓
5. 반복 실행 (for iteration = 0; iteration < repeatCount)
   a. 각 노드에 repeat_info 메타데이터 추가:
      {
        repeat_count: 3,
        is_repeat_start: (index === 0),
        is_repeat_end: (index === 마지막),
        node_index_in_repeat: index,
        total_nodes_in_repeat: 체인 길이
      }
   b. 서버에 API 요청 (/execute-nodes)
   c. 서버는 repeat_info를 확인하여 로깅
   d. 실행 결과 수집
   e. UI 업데이트 (반복 진행 상황 표시)
   ↓
6. 모든 반복 완료 후 다음 노드로 진행
```

#### 코드 예시

```python
@NodeExecutor("repeat")
async def execute(parameters: dict[str, Any]) -> dict[str, Any]:
    # 반복 횟수 추출 및 검증
    repeat_count = get_parameter(parameters, "repeat_count", default=1)
    
    if not isinstance(repeat_count, (int, float)) or repeat_count < 1:
        logger.warning(f"[RepeatNode] 잘못된 반복 횟수: {repeat_count}, 기본값 1 사용")
        repeat_count = 1
    
    # 정수로 변환
    repeat_count = int(repeat_count)
    
    logger.info(f"[RepeatNode] 반복 노드 실행 - 반복 횟수: {repeat_count}")
    
    return {
        "action": "repeat",
        "status": "completed",
        "output": {
            "repeat_count": repeat_count,
            "completed": True,
            "iterations": []  # 실제 반복 결과는 워크플로우 실행 엔진에서 채움
        },
    }
```

## 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│              반복 노드 실행 흐름 (전체)                      │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  1. 서버 측: 반복 노드 실행                           │  │
│  │     ┌────────────────────────────────────────────┐  │  │
│  │     │ RepeatNode.execute()                       │  │  │
│  │     │   - repeat_count 파라미터 추출              │  │  │
│  │     │   - 검증 (1 이상의 정수)                    │  │  │
│  │     │   - 결과 반환 (iterations는 빈 배열)         │  │  │
│  │     └──────────────┬─────────────────────────────┘  │  │
│  └────────────────────┼──────────────────────────────────┘  │
│                       │                                      │
│                       ▼                                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  2. 프론트엔드: 반복 노드 감지                        │  │
│  │     ┌────────────────────────────────────────────┐  │  │
│  │     │ WorkflowExecutionService.execute()         │  │  │
│  │     │   - nodeData.type === 'repeat' 확인        │  │  │
│  │     │   - nodeResult.output.repeat_count 추출    │  │  │
│  │     └──────────────┬─────────────────────────────┘  │  │
│  └────────────────────┼──────────────────────────────────┘  │
│                       │                                      │
│                       ▼                                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  3. 하위 노드 체인 수집                               │  │
│  │     ┌────────────────────────────────────────────┐  │  │
│  │     │ bottom-output 연결점에서 시작              │  │  │
│  │     │   - connections.filter(                    │  │  │
│  │     │       c.from === nodeData.id &&            │  │  │
│  │     │       c.outputType === 'bottom'            │  │  │
│  │     │     )                                      │  │  │
│  │     │                                            │  │  │
│  │     │ 출력 연결을 따라가며 체인 구성              │  │  │
│  │     │   - visited Set으로 순환 방지              │  │  │
│  │     │   - 반복 노드로 돌아가는 연결 제외          │  │  │
│  │     │   - 더 이상 연결이 없으면 종료              │  │  │
│  │     └──────────────┬─────────────────────────────┘  │  │
│  └────────────────────┼──────────────────────────────────┘  │
│                       │                                      │
│                       ▼                                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  4. 반복 실행 (for iteration = 0; iteration < count)│  │
│  │     ┌────────────────────────────────────────────┐  │  │
│  │     │ 각 반복마다:                                │  │  │
│  │     │   a. repeat_info 메타데이터 추가            │  │  │
│  │     │      {                                      │  │  │
│  │     │        repeat_count: 3,                    │  │  │
│  │     │        is_repeat_start: (index === 0),    │  │  │
│  │     │        is_repeat_end: (index === 마지막),  │  │  │
│  │     │        current_iteration: iteration + 1,  │  │  │
│  │     │        total_iterations: repeatCount      │  │  │
│  │     │      }                                      │  │  │
│  │     │                                            │  │  │
│  │     │   b. 서버에 API 요청                        │  │  │
│  │     │      POST /execute-nodes                   │  │  │
│  │     │      { nodes: [노드 체인], repeat_info }   │  │  │
│  │     │                                            │  │  │
│  │     │   c. 서버: repeat_info 확인하여 로깅        │  │  │
│  │     │      "[API] 반복 1/3 - 노드 1/5 실행 시작"  │  │  │
│  │     │                                            │  │  │
│  │     │   d. 실행 결과 수집                        │  │  │
│  │     │                                            │  │  │
│  │     │   e. UI 업데이트 (실시간 진행 상황 표시)    │  │  │
│  │     └──────────────┬─────────────────────────────┘  │  │
│  └────────────────────┼──────────────────────────────────┘  │
│                       │                                      │
│                       ▼                                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  5. 모든 반복 완료 후 다음 노드로 진행                 │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                              │
└──────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│              워크플로우 구조 예시                         │
│                                                          │
│  [시작]                                                  │
│    │                                                     │
│    ▼                                                     │
│  [반복 노드] (repeat_count: 3)                          │
│    │                                                     │
│    ├─→ [대기]                                           │
│    │     │                                               │
│    │     ▼                                               │
│    ├─→ [클릭]                                           │
│    │     │                                               │
│    │     ▼                                               │
│    └─→ [조건]                                           │
│          │                                               │
│          ▼                                               │
│  [다음 노드]                                             │
│                                                          │
│  실행 순서:                                              │
│  1. 시작 노드 실행                                       │
│  2. 반복 노드 실행 (반복 횟수 설정)                      │
│  3. 반복 실행 (3회):                                     │
│     - 반복 1: [대기] → [클릭] → [조건]                  │
│     - 반복 2: [대기] → [클릭] → [조건]                  │
│     - 반복 3: [대기] → [클릭] → [조건]                  │
│  4. 다음 노드 실행                                       │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

## 특징

1. **서버-프론트엔드 협력**: 서버는 반복 횟수만 검증하고, 실제 반복 실행은 프론트엔드에서 처리합니다
2. **동적 노드 체인 수집**: 하위 연결점에서 시작하여 출력 연결을 따라가며 반복할 노드 체인을 자동으로 수집합니다
3. **순환 방지**: `visited` Set을 사용하여 무한 루프를 방지합니다
4. **메타데이터 전달**: 각 노드에 `repeat_info` 메타데이터를 추가하여 서버에서 반복 정보를 활용할 수 있습니다
5. **실시간 UI 업데이트**: 각 반복마다 UI를 업데이트하여 진행 상황을 표시합니다
6. **유연한 반복 횟수**: 1 이상의 정수로 반복 횟수를 설정할 수 있습니다
7. **중첩 반복 지원**: 반복 노드 안에 또 다른 반복 노드를 넣을 수 있습니다 (중첩 반복)

## 사용 예시

### 워크플로우 예시

```
[시작] → [반복 노드] → [다음 노드]
         (3회 반복)
           │
           ├─→ [대기]
           │     │
           │     ▼
           └─→ [클릭]
```

이 워크플로우는:
1. 시작 노드로 워크플로우를 시작합니다
2. 반복 노드가 반복 횟수를 설정합니다 (3회)
3. 워크플로우 실행 엔진이 아래 노드들을 3회 반복 실행합니다:
   - 반복 1: 대기 → 클릭
   - 반복 2: 대기 → 클릭
   - 반복 3: 대기 → 클릭
4. 다음 노드로 진행합니다

### 파라미터 설정 예시

```json
{
  "repeat_count": 5
}
```

이 설정은 아래 노드들을 5회 반복 실행합니다.

### 중첩 반복 예시

```
[시작] → [반복 노드] (외부, 3회)
           │
           ├─→ [반복 노드] (내부, 2회)
           │     │
           │     ├─→ [대기]
           │     └─→ [클릭]
           │
           └─→ [조건]
```

이 워크플로우는:
- 외부 반복: 3회
  - 내부 반복: 2회 (대기 → 클릭)
  - 조건 노드 실행

총 3 × 2 = 6회의 대기/클릭이 실행됩니다.

## 주의사항

1. **워크플로우 엔진 필요**: 반복 노드는 워크플로우 실행 엔진이 있어야 제대로 동작합니다
2. **하위 노드 필요**: 반복 노드 아래에 연결된 노드가 없으면 반복할 것이 없습니다
3. **무한 루프 방지**: 반복 횟수는 1 이상의 유한한 값이어야 합니다
4. **성능 고려**: 많은 반복 횟수는 실행 시간이 길어질 수 있습니다
5. **에러 처리**: 반복 중 에러가 발생하면 해당 반복만 실패하고 다음 반복은 계속 진행됩니다 (설정에 따라 다를 수 있음)
