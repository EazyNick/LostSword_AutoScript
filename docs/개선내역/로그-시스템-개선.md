# 로그 시스템 개선: 동적 디렉토리 설정 및 레벨 제어

## 문제 상황

초기 로그 시스템에는 다음과 같은 문제들이 있었습니다:

1. **하드코딩된 경로**: 로그 파일 저장 경로가 코드에 하드코딩되어 있음
2. **설정 미적용**: `LOG_LEVEL` 환경 변수가 실제로 적용되지 않음
3. **중앙 관리 부재**: 로그 설정이 여러 곳에 분산되어 있음

## 해결 과정

### 1단계: server 폴더 기준 경로 해석

로그 디렉토리를 `server` 폴더 기준 상대 경로로 해석하도록 구현:

```python
# server/log/__init__.py
from config.server_config import settings

log_dir = settings.LOG_DIR  # 예: "log/logs"

# server 폴더 기준으로 절대 경로 변환
server_dir = Path(__file__).resolve().parent.parent
log_directory = str(server_dir / log_dir)  # server/log/logs

# 디렉토리가 없으면 생성
os.makedirs(log_directory, exist_ok=True)
```

### 2단계: 로그 레벨 적용

`LogManager`에서 환경 변수의 로그 레벨을 실제로 적용하도록 수정:

**변경 전:**
```python
logger.setLevel(logging.DEBUG)  # 항상 DEBUG
```

**변경 후:**
```python
# server_config에서 로그 레벨 읽기
from config.server_config import settings
log_level_str = settings.LOG_LEVEL
self.log_level = getattr(logging, log_level_str.upper(), logging.INFO)

# 로거에 적용
logger.setLevel(self.log_level)
stream_handler.setLevel(self.log_level)
```

### 3단계: 싱글톤 패턴 버그 수정

`LogManager`의 싱글톤 패턴에서 발생한 버그를 수정했습니다.

**문제:**
```python
def __new__(cls, *args, **kwargs):
    cls._instance = super(LogManager, cls).__new__(cls, *args, **kwargs)
    # TypeError: object.__new__() takes exactly one argument
```

**해결:**
```python
def __new__(cls, *args, **kwargs):
    if not cls._instance:
        cls._instance = super(LogManager, cls).__new__(cls)  # args, kwargs 제거
    return cls._instance
```

`object.__new__()`는 클래스만 받으므로 `*args, **kwargs`를 전달하면 안 됩니다. 파라미터는 `__init__`에서 처리됩니다.

## 기술적 결정 사항

### 1. 로그 레벨 동작 방식

로그 레벨은 설정한 레벨 이상의 로그만 출력합니다:

- `DEBUG`: 모든 로그 출력
- `INFO`: INFO 이상 출력 (DEBUG 제외)
- `WARNING`: WARNING 이상 출력
- `ERROR`: ERROR 이상 출력
- `CRITICAL`: CRITICAL만 출력

```python
# 설정된 레벨 이상만 출력
logger.setLevel(self.log_level)
stream_handler.setLevel(self.log_level)
file_handler.setLevel(logging.DEBUG)  # 파일은 항상 모든 로그 기록
```

### 2. 디렉토리 자동 생성

설정한 로그 디렉토리가 없으면 자동으로 생성:

```python
os.makedirs(log_directory, exist_ok=True)
```

### 3. 상대 경로 해석

`server` 폴더 기준으로 상대 경로를 해석하여 유연성 제공:

```python
# LOG_DIR=log/logs → server/log/logs
# LOG_DIR=logs → server/logs
server_dir = Path(__file__).resolve().parent.parent
log_directory = str(server_dir / log_dir)
```

## 결과

### 장점

1. **유연한 경로 설정**: `.env` 파일에서 로그 저장 위치 변경 가능
2. **로그 레벨 제어**: 환경에 따라 로그 출력 레벨 조절 가능
3. **자동 디렉토리 생성**: 설정한 경로가 없어도 자동 생성
4. **중앙 관리**: 모든 로그 설정이 `server_config`에서 관리됨

### 사용 예시

```env
# 개발 환경: 모든 로그 출력, server/log/logs에 저장
ENVIRONMENT=dev
LOG_LEVEL=DEBUG
LOG_DIR=log/logs

# 프로덕션 환경: 에러만 출력, server/logs/production에 저장
ENVIRONMENT=prd
LOG_LEVEL=ERROR
LOG_DIR=logs/production
```

## 적용 범위

다음 파일들이 로그 설정을 사용합니다:

- `server/log/__init__.py`: LOG_DIR 읽기 및 디렉토리 생성
- `server/log/log_manager.py`: LOG_LEVEL 읽기 및 적용
- `server/config/server_config.py`: 환경 변수 정의

